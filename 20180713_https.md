# HTTPS with SSL for Nginx and Kestrel

Internet is moving toward secure connections whereby HTTPS is a priority. Browsers are now warning users when navigating to non secured website. With this movement, Kestrel and ASPNET Core have adopted the mentality of security by default rather than security when needed. HTTPS will now be the default and HTTP will be a necessity due to implementation constraints. Together with Lets Encrypt and ACME protocol, we do not have excuses for not implementing an SSL connection.

1. Setup the example
2. SSL self signed certificate for Nginx
3. SSL self signed certificate for Kestrel

## 1. Setup the example

We assume that our environment is on Ubuntu, with nginx and dotnet installed.
If you are on Windows, you can [install the linux subsystem with Ubuntu 16.04 as describe on my previous post](https://kimsereyblog.blogspot.com/2018/03/install-dotnet-on-ubuntu-with-linux.html). This will give access to most of the features of Ubuntu via a bash prompt.

To start we create a HelloWorld application with dotnet. Here is the `Startup.cs` which simply serves a `Hello world`.

```c#
public class Startup
{
    public void ConfigureServices(IServiceCollection services) { }

    public void Configure(IApplicationBuilder app, IHostingEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }
        
        app.Run(async (context) =>
        {
            await context.Response.WriteAsync("Hello World!");
        });
    }
}
```

When we run this application, we can access `http://localhost:5000`.
Next we configure our localhost proxy with nginx. We create `localhost` file in `/etc/nginx/sites-available/` where we proxy `localhost` calls to `localhost:5000`.

```txt
server {
    listen 80;
    include /etc/nginx/proxy_params;

    proxy_http_version 1.1;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Upgrade $http_upgrade;

    location / {
        proxy_pass http://localhost:5000;
    }
}
```

Next symlink the file and remove the default file. And restart nginx:

```sh
sudo ln -s /etc/nginx/sites-available/localhost /etc/nginx/sites-enabled/localhost
sudo rm /etc/nginx/sites-enabled/default
sudo service nginx restart
```

Now when we navigate to `http://localhost`, we should have our call proxied to `http://localhost:5000`. So far we have the following:

```txt
Browser --(http)--> nginx --(http)--> kestrel
```

So far none of our connection is secured.

## 2. SSL self signed certificate for Nginx

The first communication is over internet therefore in order to keep the confidentiality of the commumication we can configure.

Here we will be creating a self signed certification which means that the certificate is issued and signed by ourselves instead of being issues by a trusted certificate authority. The difference is that our certificate will not be trusted by default in the browser. 

_If you need a SSL certificate signed by a trusted CA, you can install SSL nginx using Certbot but you would need to have a valid domain._

So we start first by create a X509 certificate which we will use to setup SSL on Nginx. To create it we will use the same method as explain in my previous post on [create a self signed certificate with Openssl](https://kimsereyblog.blogspot.com/2018/07/selfsigned-certificate-for-identity.html).

```sh
sudo openssl req -x509 -newkey rsa:4096 -keyout localhost.key -out localhost.crt -days 3650 -nodes -subj "/CN=localhost" -config config.cnf
```

`config.cnf` is the copy of the configuration from OpenSSL which has been modified to [add the subject alternate name as discussed in my previous post in section 3)](https://kimsereyblog.blogspot.com/2018/07/selfsigned-certificate-for-identity.html).
Then we move the created certificate and key to `/etc/localhost` and use it to configure SSL on Nginx:

```txt
server {
    listen 443 ssl;
    ssl_certificate /etc/localhost/localhost.crt;
    ssl_certificate_key /etc/localhost/localhost.key;

    include /etc/nginx/proxy_params;

    proxy_http_version 1.1;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Upgrade $http_upgrade;

    location / {
        proxy_pass http://localhost:5000;
    }
}
```

Now when we navigate to `https://localhost`, our communication is encrypted using the SSL cert we created and then proxied as `http://localhost:5000`.

So far we have the following:

```txt
Browser --(https)--> nginx --(http)--> kestrel
```

## 3. SSL self signed certificate for Kestrel

Now that we have secured the connection to nginx, we can secure the connection to Kestrel.

Since nginx and kestrel are both on localhost in our example (as we are developing locally), we can use the same certificate which we created as it is bound to the `localhost` common name.

We start by combining `.crt` and `.key` into a `.pfx` file to be used by Kestrel.

```
...
```

Next we add the HTTPS configuration on the `WebHostBuilder`.

```
...
```

Now when we navigate to https://localhost5001, our connection will be secured when directly interacting with Kestrel. Since Nginx proxies calls to Kestrel, we need to have Nginx verify whether the SSL certificate delivered by Kestrel is valid. We can do that by using the directives `proxy_ssl_trusted_certificate` and `proxy_ssl_verify`.

```
proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.cer; 
proxy_ssl_verify on;
```

`ca-certificates.cer` contains all certificate trusted by the system. If we want Nginx to trust our `localhost.cer`, we will need to configure Ubuntu to recognize it. To do so, we need to use the `update-ca-certificates` command.
We start by placing our certificate under `/usr/local/share/ca-certificates/localhost/` then run the command `sudo update-ca-certificates`. The `ca-certificates` folder is scanned during the update and the certificate is added into `ca-certificates.cer`.

And we are done! Now all our communication will be encrypted.

```
Browser --(https)--> nginx --(https)--> kestrel
```