# Hashicorp Vault behind IIS

Last week I talked about [Hashicorp Vault and how it could be used to store secrets](https://kimsereyblog.blogspot.sg/2018/03/manage-secrets-with-hashicorp-vault.html). Today I will continue on the same line and show how we can host Vault behind IIS and use what we learnt in the previous post to retrieve secrets from ASP.NET Core.

1. Setup Vault
2. Read secrets from Vault from ASP.NET Core

## 1. Setup Vault

Vault is a webserver which comes with a complete API. In this example, we will show how to setup Vault and proxy calls from IIS to Vault.

### 1.1 Boot Vault

To begin with, we can follow the same steps described in my previous post - [Hashicorp Vault and how it could be used to store secrets](https://kimsereyblog.blogspot.sg/2018/03/manage-secrets-with-hashicorp-vault.html). As a quick overview, here are the steps to be executed inside Windows Server:

- download Vault
- create the config.hcl file
- run the command `Vault server -c=config.hcl`

In config.hcl, we configured Vault to listen on http://localhost:8200 so the next thing to do is to proxy calls from IIS to Vault process.

### 1.2 Configure IIS to direct calls to Vault process

_We assume that we alaready have an ASP.NET Core application registered as a Website on IIS. If you aren't familiar with ASP.NET Core with IIS, you can refer to my blogpost on [how to setup an ASP.NET Core application behind IIS](https://kimsereyblog.blogspot.sg/2018/03/lets-encrypt-for-aspnet-core.html)._

#### 1.2.1 Prepare the ASP.NET Core application

By default IIS only allows to register websites. In this sample we will be hosting [our sample application](https://github.com/Kimserey/hashicorp-vault-test), this application contains a single endpoints `GET /secrets` which returns a database connection secrets.

To host it, we start by compiling the artefact with `dotnet publish -c Release`. Then we copy the files from the publish folder into the server and create a IIS Website and specify the location as physical path of the website. (If you are having issue with serving your application, make sure you have installed the dotnet runtime and AspNetCore runtime on the server and that you have installed the IIS module for ASP.NET Core [as explained in my previous post](https://kimsereyblog.blogspot.sg/2018/03/lets-encrypt-for-aspnet-core.html)).

From within the server, if our installation of the application has been successful, we can open PowerShell and execute `Invoke-WebRequest` we should get the following:

```ps1
PS> Invoke-WebRequest -Uri "http://localhost/secrets"

StatusCode        : 200
StatusDescription : OK
Content           : {"databaseConnection":null}
```

#### 1.2.2 Setup Vault as sub application

Now that we have the application running on `*:80`, we can install Vault as a sub application on a path `*:80/vault`.
For the physical path of this sub application, we can create a folder in the application itself, this folder will be used to save the web.

What we want is when someone hit `myapp.com` or `myapp.com/abc`, it will hit our ASP.NET Core application but when someone hits `myapp.com/vault` or `myapp.com/vault/v1/secret/myapp`, it will hit Vault.

To do that we will need two IIS modules:

- URL rewrite [https://www.iis.net/downloads/microsoft/url-rewrite](https://www.iis.net/downloads/microsoft/url-rewrite)
- Application Request Routing (ARR) [https://www.iis.net/downloads/microsoft/application-request-routing](https://www.iis.net/downloads/microsoft/application-request-routing)

After we have installed the modules, we can create `web.config` under the Vault folder with the following content:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <rewrite>
            <rules>
                <rule name="Rewrite to vault" patternSyntax="Wildcard">
                    <match url="*" />
                    <action type="Rewrite" url="http://localhost:8200/{R:1}" />
                </rule>
            </rules>
        </rewrite>
    </system.webServer>
</configuration>
```

This will configure the URL rewrite to forward anything after the `/vault` prefix to the process hosted on `*:8300`.

By default IIS does not allow proxying to a different domain so when the request comes from `myapp.com/vault/[...]`, it isn't possible to reroute it to `localhost:8200/[...]`.

To enable that, we will make use of ARR which we already downloaded and installed. To activate it, we need to go to main server configuration and click on Application Request Routing under IIS.

![ARR]()

Then go to __Proxy > Server Proxy Settings__ and enable __Pass Through__ proxying.

![pass_through]()

Now that we have it setup, we should be able to hit Vault API from the path:

```ps1
PS> Invoke-WebRequest -Uri "http://localhost/vault/v1/secret/myapp" -Headers @{"x-vault-token"="[your token]"}


StatusCode        : 200
StatusDescription : OK
Content           : {"request_id":"b1d99860-b330-5a15-203a-06352154291e", "lease_id":"","renewable":false,"lease_duration":2764800,"data":{"databaseConnection":"123abc"},"wrap_info":null,"warnings":null,"auth":null}
```